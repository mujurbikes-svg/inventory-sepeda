<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventaris Toko Sepeda</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --dark-color: #2c3e50;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            padding-bottom: 70px;
        }
        
        .navbar {
            background-color: var(--dark-color);
        }
        
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
            border: none;
        }
        
        .card-header {
            background-color: white;
            border-bottom: 1px solid #eee;
            font-weight: 600;
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .status-unassembled {
            background-color: var(--warning-color);
            color: white;
        }
        
        .status-assembled {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .status-sold {
            background-color: var(--danger-color);
            color: white;
        }
        
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: white;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }
        
        .nav-item {
            text-align: center;
            padding: 10px 0;
            flex: 1;
        }
        
        .nav-item.active {
            color: var(--primary-color);
        }
        
        .nav-icon {
            font-size: 1.5rem;
            display: block;
        }
        
        .nav-label {
            font-size: 0.8rem;
            margin-top: 2px;
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        .bike-item {
            transition: transform 0.2s;
        }
        
        .bike-item:hover {
            transform: translateY(-2px);
        }
        
        .qr-container {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 10px;
            margin: 20px auto;
            max-width: 300px;
        }
        
        .scanner-container {
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
            position: relative;
        }
        
        #camera-feed {
            width: 100%;
            max-width: 400px;
            height: 300px;
            background-color: #000;
            margin: 0 auto;
            display: block;
            border-radius: 10px;
        }
        
        .scan-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 2px solid white;
            border-radius: 10px;
            box-shadow: 0 0 0 1000px rgba(0, 0, 0, 0.3);
        }
        
        .form-section {
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 10px;
        }
        
        #file-input {
            display: none;
        }
        
        .qr-label-container {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            margin-top: 10px;
        }
        
        .qr-code-small {
            width: 30%;
            flex-shrink: 0;
        }
        
        .qr-code-small img {
            width: 100%;
            height: auto;
        }
        
        .qr-info {
            flex: 1;
            text-align: left;
            font-size: 11px;
            line-height: 1.3;
        }
        
        .qr-info strong {
            display: block;
            margin-bottom: 3px;
            font-size: 12px;
        }
        
        @media print {
            body * {
                visibility: hidden;
            }
            #printable-qr, #printable-qr * {
                visibility: visible;
            }
            #printable-qr {
                position: absolute;
                left: 0;
                top: 0;
                width: 58mm;
                padding: 5px;
            }
        }
        
        .printable-qr {
            width: 58mm;
            padding: 5px;
            border: 1px dashed #ccc;
            margin: 10px auto;
            background: white;
        }
        
        .package-unit-input {
            margin-top: 8px;
        }
        
        .unit-count-badge {
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
            position: absolute;
            top: -8px;
            right: -8px;
        }
        
        .quick-scan-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            border: none;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        .search-box {
            margin-bottom: 15px;
        }
        
        .bike-card-content {
            position: relative;
        }
        
        .bike-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .image-placeholder {
            width: 100%;
            height: 150px;
            background-color: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            margin-bottom: 10px;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .action-buttons .btn {
            flex: 1;
            min-width: 120px;
        }
        
        .photo-preview {
            max-width: 100%;
            max-height: 200px;
            margin-top: 10px;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <!-- Quick Scan Button -->
    <button class="quick-scan-btn" id="quick-scan-btn" title="Quick Scan QR">
        <i class="fas fa-qrcode"></i>
    </button>

    <!-- Quick Scan Modal -->
    <div class="modal fade" id="quickScanModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Quick Scan QR Code</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <p>Pilih metode scanning:</p>
                        <button class="btn btn-primary w-100 mb-2" id="modal-camera-scan-btn">
                            <i class="fas fa-camera me-1"></i> Gunakan Kamera
                        </button>
                        <button class="btn btn-secondary w-100" id="modal-upload-scan-btn">
                            <i class="fas fa-upload me-1"></i> Upload Gambar QR
                        </button>
                        <input type="file" id="modal-file-input" accept="image/*">
                    </div>
                    
                    <div id="modal-camera-container" style="display: none;">
                        <video id="modal-camera-feed" autoplay playsinline></video>
                        <div class="scan-overlay"></div>
                        <button class="btn btn-danger w-100 mt-2" id="modal-stop-camera-btn">
                            <i class="fas fa-stop me-1"></i> Hentikan Kamera
                        </button>
                    </div>
                    
                    <div id="modal-scan-result" class="mt-3 text-center"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Assembly Modal -->
    <div class="modal fade" id="assemblyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Tandai Sepeda Sudah Rakit</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="assembly-form">
                        <div class="mb-3">
                            <label for="assembly-date" class="form-label">Tanggal Perakitan</label>
                            <input type="date" class="form-control" id="assembly-date" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="assembly-assembler" class="form-label">Nama Perakit</label>
                            <select class="form-select" id="assembly-assembler" required>
                                <option value="">Pilih Perakit</option>
                            </select>
                            <div class="form-text">
                                <a href="#" id="add-assembler-btn">+ Tambah perakit baru</a>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="assembly-quantity" class="form-label">Jumlah yang Dirakit</label>
                            <input type="number" class="form-control" id="assembly-quantity" value="1" min="1" required>
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-100">Simpan Perakitan</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Sale Modal -->
    <div class="modal fade" id="saleModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Tandai Sepeda Terjual</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="sale-form">
                        <div class="mb-3">
                            <label for="sale-date" class="form-label">Tanggal Penjualan</label>
                            <input type="date" class="form-control" id="sale-date" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="sale-quantity" class="form-label">Jumlah yang Terjual</label>
                            <input type="number" class="form-control" id="sale-quantity" value="1" min="1" required>
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-100">Simpan Penjualan</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Bike Modal -->
    <div class="modal fade" id="editBikeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Data Sepeda</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-bike-form">
                        <input type="hidden" id="edit-bike-id">
                        
                        <div class="mb-3">
                            <label for="edit-bike-name" class="form-label">Nama Sepeda</label>
                            <input type="text" class="form-control" id="edit-bike-name" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="edit-bike-type" class="form-label">Tipe</label>
                            <select class="form-select" id="edit-bike-type" required>
                                <option value="">Pilih Tipe</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="edit-bike-size" class="form-label">Ukuran</label>
                            <select class="form-select" id="edit-bike-size" required>
                                <option value="">Pilih Ukuran</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="edit-bike-supplier" class="form-label">Supplier</label>
                            <select class="form-select" id="edit-bike-supplier" required>
                                <option value="">Pilih Supplier</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="edit-bike-package" class="form-label">Kemasan</label>
                            <select class="form-select" id="edit-bike-package" required>
                                <option value="">Pilih Kemasan</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="edit-bike-photo" class="form-label">Foto Sepeda</label>
                            <input type="file" class="form-control" id="edit-bike-photo" accept="image/*">
                            <div class="form-text">Unggah foto sepeda (opsional)</div>
                        </div>
                        
                        <div id="edit-photo-preview-container"></div>
                        
                        <button type="submit" class="btn btn-primary w-100">Simpan Perubahan</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="navbar navbar-dark">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-bicycle me-2"></i>Inventaris Sepeda
            </span>
            <button class="btn btn-outline-light btn-sm" id="export-btn">
                <i class="fas fa-download"></i>
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-3">
        <!-- Dashboard Page -->
        <div id="dashboard-page" class="page active">
            <h4 class="mb-3">Dashboard Inventaris</h4>
            
            <div class="row mb-4">
                <div class="col-4">
                    <div class="card text-center bg-warning text-white">
                        <div class="card-body py-3">
                            <h5 id="unassembled-count">0</h5>
                            <small>Belum Rakit</small>
                        </div>
                    </div>
                </div>
                <div class="col-4">
                    <div class="card text-center bg-success text-white">
                        <div class="card-body py-3">
                            <h5 id="assembled-count">0</h5>
                            <small>Sudah Rakit</small>
                        </div>
                    </div>
                </div>
                <div class="col-4">
                    <div class="card text-center bg-danger text-white">
                        <div class="card-body py-3">
                            <h5 id="low-stock-count">0</h5>
                            <small>Stok Tipis</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Search Box -->
            <div class="search-box">
                <div class="input-group">
                    <input type="text" class="form-control" id="search-input" placeholder="Cari sepeda...">
                    <button class="btn btn-outline-secondary" type="button" id="clear-search">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="d-flex mb-3">
                <button class="btn btn-outline-primary me-2 active filter-btn" data-status="all">Semua</button>
                <button class="btn btn-outline-warning me-2 filter-btn" data-status="unassembled">Belum Rakit</button>
                <button class="btn btn-outline-success me-2 filter-btn" data-status="assembled">Sudah Rakit</button>
            </div>
            
            <div id="bike-list">
                <!-- Daftar sepeda akan dimuat di sini -->
            </div>
        </div>

        <!-- Add Bike Page -->
        <div id="add-bike-page" class="page">
            <h4 class="mb-3">Tambah Sepeda Baru</h4>
            
            <div class="form-section">
                <form id="bike-form">
                    <div class="mb-3">
                        <label for="bike-name" class="form-label">Nama Sepeda</label>
                        <input type="text" class="form-control" id="bike-name" required style="text-transform: uppercase;">
                    </div>
                    
                    <div class="mb-3">
                        <label for="bike-type" class="form-label">Tipe</label>
                        <select class="form-select" id="bike-type" required>
                            <option value="">Pilih Tipe</option>
                        </select>
                        <div class="form-text">
                            <a href="#" id="add-type-btn">+ Tambah tipe baru</a>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="bike-size" class="form-label">Ukuran</label>
                        <select class="form-select" id="bike-size" required>
                            <option value="">Pilih Ukuran</option>
                        </select>
                        <div class="form-text">
                            <a href="#" id="add-size-btn">+ Tambah ukuran baru</a>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="bike-supplier" class="form-label">Supplier</label>
                        <select class="form-select" id="bike-supplier" required>
                            <option value="">Pilih Supplier</option>
                        </select>
                        <div class="form-text">
                            <a href="#" id="add-supplier-btn">+ Tambah supplier baru</a>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="bike-package" class="form-label">Kemasan</label>
                        <select class="form-select" id="bike-package" required>
                            <option value="">Pilih Kemasan</option>
                        </select>
                        <div class="form-text">
                            <a href="#" id="add-package-btn">+ Tambah kemasan baru</a>
                        </div>
                    </div>
                    
                    <div class="mb-3 package-unit-input">
                        <label for="units-per-package" class="form-label">Unit per Kemasan</label>
                        <input type="number" class="form-control" id="units-per-package" value="1" min="1" required>
                        <div class="form-text">Jumlah unit dalam satu kemasan</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="package-quantity" class="form-label">Jumlah Kemasan</label>
                        <input type="number" class="form-control" id="package-quantity" value="1" min="1" required>
                        <div class="form-text">Total kemasan yang diterima</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="bike-photo" class="form-label">Foto Sepeda</label>
                        <input type="file" class="form-control" id="bike-photo" accept="image/*">
                        <div class="form-text">Unggah foto sepeda (opsional)</div>
                    </div>
                    
                    <div id="photo-preview-container"></div>
                    
                    <div class="mb-3">
                        <label for="arrival-date" class="form-label">Tanggal Kedatangan</label>
                        <input type="date" class="form-control" id="arrival-date" required>
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100">Simpan Sepeda</button>
                </form>
            </div>
        </div>

        <!-- QR Tools Page -->
        <div id="qr-page" class="page">
            <h4 class="mb-3">QR Code Tools</h4>
            
            <ul class="nav nav-tabs mb-3" id="qrTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="generate-tab" data-bs-toggle="tab" data-bs-target="#generate" type="button" role="tab">Generate QR</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="scan-tab" data-bs-toggle="tab" data-bs-target="#scan" type="button" role="tab">Scan QR</button>
                </li>
            </ul>
            
            <div class="tab-content" id="qrTabsContent">
                <div class="tab-pane fade show active" id="generate" role="tabpanel">
                    <div class="mb-3">
                        <label for="bike-select" class="form-label">Pilih Sepeda</label>
                        <select class="form-select" id="bike-select">
                            <option value="">Pilih sepeda untuk generate QR</option>
                        </select>
                    </div>
                    
                    <div id="qr-code-container" class="qr-container" style="display: none;">
                        <div id="printable-qr" class="printable-qr">
                            <div class="qr-label-container">
                                <div class="qr-code-small" id="qrcode"></div>
                                <div class="qr-info">
                                    <strong id="qr-bike-name"></strong>
                                    <div id="qr-bike-type-size"></div>
                                    <div id="qr-bike-supplier"></div>
                                    <div id="qr-bike-arrival"></div>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex gap-2 mt-2">
                            <button class="btn btn-outline-primary flex-fill" id="print-qr">
                                <i class="fas fa-print me-1"></i> Print Label
                            </button>
                            <button class="btn btn-outline-success flex-fill" id="download-qr">
                                <i class="fas fa-download me-1"></i> Download
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="tab-pane fade" id="scan" role="tabpanel">
                    <div class="mb-3">
                        <p>Pilih metode scanning:</p>
                        <button class="btn btn-primary w-100 mb-2" id="camera-scan-btn">
                            <i class="fas fa-camera me-1"></i> Gunakan Kamera
                        </button>
                        <button class="btn btn-secondary w-100" id="upload-scan-btn">
                            <i class="fas fa-upload me-1"></i> Upload Gambar QR
                        </button>
                        <input type="file" id="file-input" accept="image/*">
                    </div>
                    
                    <div id="camera-container" style="display: none;">
                        <video id="camera-feed" autoplay playsinline></video>
                        <div class="scan-overlay"></div>
                        <button class="btn btn-danger w-100 mt-2" id="stop-camera-btn">
                            <i class="fas fa-stop me-1"></i> Hentikan Kamera
                        </button>
                    </div>
                    
                    <div id="scan-result" class="mt-3 text-center"></div>
                </div>
            </div>
        </div>

        <!-- Data Master Page -->
        <div id="master-data-page" class="page">
            <h4 class="mb-3">Data Master</h4>
            
            <ul class="nav nav-pills mb-3" id="masterTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="type-tab" data-bs-toggle="pill" data-bs-target="#type" type="button">Tipe</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="size-tab" data-bs-toggle="pill" data-bs-target="#size" type="button">Ukuran</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="supplier-tab" data-bs-toggle="pill" data-bs-target="#supplier" type="button">Supplier</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="package-tab" data-bs-toggle="pill" data-bs-target="#package" type="button">Kemasan</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="assembler-tab" data-bs-toggle="pill" data-bs-target="#assembler" type="button">Perakit</button>
                </li>
            </ul>
            
            <div class="tab-content" id="masterTabsContent">
                <div class="tab-pane fade show active" id="type" role="tabpanel">
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="new-type" placeholder="Tambah tipe baru">
                        <button class="btn btn-primary" type="button" id="save-type">Tambah</button>
                    </div>
                    <ul class="list-group" id="type-list">
                        <!-- Daftar tipe akan dimuat di sini -->
                    </ul>
                </div>
                
                <div class="tab-pane fade" id="size" role="tabpanel">
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="new-size" placeholder="Tambah ukuran baru">
                        <button class="btn btn-primary" type="button" id="save-size">Tambah</button>
                    </div>
                    <ul class="list-group" id="size-list">
                        <!-- Daftar ukuran akan dimuat di sini -->
                    </ul>
                </div>
                
                <div class="tab-pane fade" id="supplier" role="tabpanel">
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="new-supplier" placeholder="Tambah supplier baru">
                        <button class="btn btn-primary" type="button" id="save-supplier">Tambah</button>
                    </div>
                    <ul class="list-group" id="supplier-list">
                        <!-- Daftar supplier akan dimuat di sini -->
                    </ul>
                </div>
                
                <div class="tab-pane fade" id="package" role="tabpanel">
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="new-package" placeholder="Tambah kemasan baru">
                        <button class="btn btn-primary" type="button" id="save-package">Tambah</button>
                    </div>
                    <ul class="list-group" id="package-list">
                        <!-- Daftar kemasan akan dimuat di sini -->
                    </ul>
                </div>
                
                <div class="tab-pane fade" id="assembler" role="tabpanel">
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="new-assembler" placeholder="Tambah perakit baru">
                        <button class="btn btn-primary" type="button" id="save-assembler">Tambah</button>
                    </div>
                    <ul class="list-group" id="assembler-list">
                        <!-- Daftar perakit akan dimuat di sini -->
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="d-flex">
            <div class="nav-item active" data-page="dashboard-page">
                <i class="nav-icon fas fa-home"></i>
                <div class="nav-label">Dashboard</div>
            </div>
            <div class="nav-item" data-page="add-bike-page">
                <i class="nav-icon fas fa-plus-circle"></i>
                <div class="nav-label">Tambah</div>
            </div>
            <div class="nav-item" data-page="qr-page">
                <i class="nav-icon fas fa-qrcode"></i>
                <div class="nav-label">QR Code</div>
            </div>
            <div class="nav-item" data-page="master-data-page">
                <i class="nav-icon fas fa-cog"></i>
                <div class="nav-label">Data Master</div>
            </div>
        </div>
    </div>

    <!-- Bootstrap & jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Data Storage
        let bikes = JSON.parse(localStorage.getItem('bikes')) || [];
        let masterData = JSON.parse(localStorage.getItem('masterData')) || {
            types: ['Mountain Bike', 'Road Bike', 'City Bike', 'BMX'],
            sizes: ['16"', '18"', '20"', '24"', '26"', '27.5"', '29"'],
            suppliers: ['Supplier A', 'Supplier B', 'Supplier C'],
            packages: ['Kardus', 'Plastik', 'Kayu'],
            assemblers: ['Andi', 'Budi', 'Citra']
        };

        // Initialize App
        $(document).ready(function() {
            // Initialize master data in localStorage if not exists
            if (!localStorage.getItem('masterData')) {
                localStorage.setItem('masterData', JSON.stringify(masterData));
            }
            
            // Set current date for forms
            const today = new Date().toISOString().split('T')[0];
            $('#arrival-date').val(today);
            $('#assembly-date').val(today);
            $('#sale-date').val(today);
            
            // Load initial data
            loadMasterDataToForms();
            loadBikeList();
            updateDashboardCounts();
            loadBikeSelect();
            loadAssemblersToForm();
            
            // Navigation
            $('.nav-item').click(function() {
                $('.nav-item').removeClass('active');
                $(this).addClass('active');
                
                const pageId = $(this).data('page');
                $('.page').removeClass('active');
                $('#' + pageId).addClass('active');
                
                // Initialize tabs when page is shown
                if (pageId === 'qr-page') {
                    initializeQRTabs();
                } else if (pageId === 'master-data-page') {
                    initializeMasterTabs();
                }
            });
            
            // Initialize tabs on page load
            initializeQRTabs();
            initializeMasterTabs();
            
            // Filter bikes by status
            $('.filter-btn').click(function() {
                $('.filter-btn').removeClass('active');
                $(this).addClass('active');
                
                const status = $(this).data('status');
                loadBikeList(status);
            });
            
            // Search functionality
            $('#search-input').on('input', function() {
                loadBikeList();
            });
            
            $('#clear-search').click(function() {
                $('#search-input').val('');
                loadBikeList();
            });
            
            // Add bike form submission
            $('#bike-form').submit(function(e) {
                e.preventDefault();
                
                const unitsPerPackage = parseInt($('#units-per-package').val());
                const packageQuantity = parseInt($('#package-quantity').val());
                const totalUnits = unitsPerPackage * packageQuantity;
                
                // Get photo data if exists
                const photoFile = $('#bike-photo')[0].files[0];
                let photoData = null;
                
                if (photoFile) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        photoData = e.target.result;
                        saveBikes(unitsPerPackage, packageQuantity, totalUnits, photoData);
                    };
                    reader.readAsDataURL(photoFile);
                } else {
                    saveBikes(unitsPerPackage, packageQuantity, totalUnits, null);
                }
            });
            
            // Function to save bikes after photo processing
            function saveBikes(unitsPerPackage, packageQuantity, totalUnits, photoData) {
                // Create multiple bike entries based on total units
                for (let i = 0; i < totalUnits; i++) {
                    const bikeData = {
                        id: Date.now().toString() + '-' + i,
                        name: $('#bike-name').val().toUpperCase(),
                        type: $('#bike-type').val(),
                        size: $('#bike-size').val(),
                        supplier: $('#bike-supplier').val(),
                        package: $('#bike-package').val(),
                        unitsPerPackage: unitsPerPackage,
                        packageQuantity: packageQuantity,
                        unitNumber: i + 1,
                        totalUnits: totalUnits,
                        arrivalDate: $('#arrival-date').val(),
                        assemblyDate: null,
                        assembler: null,
                        soldDate: null,
                        status: 'unassembled',
                        photo: photoData
                    };
                    
                    bikes.push(bikeData);
                }
                
                localStorage.setItem('bikes', JSON.stringify(bikes));
                
                // Reset form
                $('#bike-form')[0].reset();
                $('#units-per-package').val(1);
                $('#package-quantity').val(1);
                $('#arrival-date').val(today);
                $('#photo-preview-container').empty();
                
                // Show success message
                alert(`Berhasil menambahkan ${totalUnits} unit sepeda!`);
                
                // Update UI
                loadBikeList();
                updateDashboardCounts();
                loadBikeSelect();
                
                // Navigate to dashboard
                $('.nav-item').removeClass('active');
                $('.nav-item[data-page="dashboard-page"]').addClass('active');
                $('.page').removeClass('active');
                $('#dashboard-page').addClass('active');
            }
            
            // Photo preview for add form
            $('#bike-photo').change(function() {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        $('#photo-preview-container').html(`<img src="${e.target.result}" class="photo-preview" alt="Preview">`);
                    };
                    reader.readAsDataURL(file);
                } else {
                    $('#photo-preview-container').empty();
                }
            });
            
            // Photo preview for edit form
            $('#edit-bike-photo').change(function() {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        $('#edit-photo-preview-container').html(`<img src="${e.target.result}" class="photo-preview" alt="Preview">`);
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Add master data items
            $('#save-type').click(function() {
                const newType = $('#new-type').val().trim();
                if (newType && !masterData.types.includes(newType)) {
                    masterData.types.push(newType);
                    localStorage.setItem('masterData', JSON.stringify(masterData));
                    $('#new-type').val('');
                    loadMasterDataToForms();
                    loadTypeList();
                }
            });
            
            $('#save-size').click(function() {
                const newSize = $('#new-size').val().trim();
                if (newSize && !masterData.sizes.includes(newSize)) {
                    masterData.sizes.push(newSize);
                    localStorage.setItem('masterData', JSON.stringify(masterData));
                    $('#new-size').val('');
                    loadMasterDataToForms();
                    loadSizeList();
                }
            });
            
            $('#save-supplier').click(function() {
                const newSupplier = $('#new-supplier').val().trim();
                if (newSupplier && !masterData.suppliers.includes(newSupplier)) {
                    masterData.suppliers.push(newSupplier);
                    localStorage.setItem('masterData', JSON.stringify(masterData));
                    $('#new-supplier').val('');
                    loadMasterDataToForms();
                    loadSupplierList();
                }
            });
            
            $('#save-package').click(function() {
                const newPackage = $('#new-package').val().trim();
                if (newPackage && !masterData.packages.includes(newPackage)) {
                    masterData.packages.push(newPackage);
                    localStorage.setItem('masterData', JSON.stringify(masterData));
                    $('#new-package').val('');
                    loadMasterDataToForms();
                    loadPackageList();
                }
            });
            
            $('#save-assembler').click(function() {
                const newAssembler = $('#new-assembler').val().trim();
                if (newAssembler && !masterData.assemblers.includes(newAssembler)) {
                    masterData.assemblers.push(newAssembler);
                    localStorage.setItem('masterData', JSON.stringify(masterData));
                    $('#new-assembler').val('');
                    loadAssemblersToForm();
                    loadAssemblerList();
                }
            });
            
            // Quick add from bike form
            $('#add-type-btn').click(function(e) {
                e.preventDefault();
                $('#masterTabs .nav-link').removeClass('active');
                $('#type-tab').addClass('active');
                $('#masterTabsContent .tab-pane').removeClass('show active');
                $('#type').addClass('show active');
                
                $('.nav-item').removeClass('active');
                $('.nav-item[data-page="master-data-page"]').addClass('active');
                $('.page').removeClass('active');
                $('#master-data-page').addClass('active');
            });
            
            $('#add-size-btn').click(function(e) {
                e.preventDefault();
                $('#masterTabs .nav-link').removeClass('active');
                $('#size-tab').addClass('active');
                $('#masterTabsContent .tab-pane').removeClass('show active');
                $('#size').addClass('show active');
                
                $('.nav-item').removeClass('active');
                $('.nav-item[data-page="master-data-page"]').addClass('active');
                $('.page').removeClass('active');
                $('#master-data-page').addClass('active');
            });
            
            $('#add-supplier-btn').click(function(e) {
                e.preventDefault();
                $('#masterTabs .nav-link').removeClass('active');
                $('#supplier-tab').addClass('active');
                $('#masterTabsContent .tab-pane').removeClass('show active');
                $('#supplier').addClass('show active');
                
                $('.nav-item').removeClass('active');
                $('.nav-item[data-page="master-data-page"]').addClass('active');
                $('.page').removeClass('active');
                $('#master-data-page').addClass('active');
            });
            
            $('#add-package-btn').click(function(e) {
                e.preventDefault();
                $('#masterTabs .nav-link').removeClass('active');
                $('#package-tab').addClass('active');
                $('#masterTabsContent .tab-pane').removeClass('show active');
                $('#package').addClass('show active');
                
                $('.nav-item').removeClass('active');
                $('.nav-item[data-page="master-data-page"]').addClass('active');
                $('.page').removeClass('active');
                $('#master-data-page').addClass('active');
            });
            
            $('#add-assembler-btn').click(function(e) {
                e.preventDefault();
                $('#masterTabs .nav-link').removeClass('active');
                $('#assembler-tab').addClass('active');
                $('#masterTabsContent .tab-pane').removeClass('show active');
                $('#assembler').addClass('show active');
                
                $('.nav-item').removeClass('active');
                $('.nav-item[data-page="master-data-page"]').addClass('active');
                $('.page').removeClass('active');
                $('#master-data-page').addClass('active');
            });
            
            // Generate QR Code
            $('#bike-select').change(function() {
                const bikeId = $(this).val();
                if (bikeId) {
                    const bike = bikes.find(b => b.id === bikeId);
                    if (bike) {
                        $('#qr-code-container').show();
                        $('#qrcode').empty();
                        
                        // Generate QR Code using qrcode-generator library
                        const qr = qrcode(0, 'M');
                        qr.addData(bikeId);
                        qr.make();
                        
                        $('#qrcode').html(qr.createImgTag(2));
                        $('#qr-bike-name').text(bike.name);
                        $('#qr-bike-type-size').text(`${bike.type} - ${bike.size}`);
                        $('#qr-bike-supplier').text(`Supplier: ${bike.supplier}`);
                        $('#qr-bike-arrival').text(`Tgl: ${formatDate(bike.arrivalDate)}`);
                    }
                } else {
                    $('#qr-code-container').hide();
                }
            });
            
            // Print QR Code
            $('#print-qr').click(function() {
                const printContent = document.getElementById('printable-qr').innerHTML;
                const originalContent = document.body.innerHTML;
                
                document.body.innerHTML = printContent;
                window.print();
                document.body.innerHTML = originalContent;
                
                // Reload the page to restore functionality
                location.reload();
            });
            
            // Download QR Code
            $('#download-qr').click(function() {
                const img = document.querySelector('#qrcode img');
                if (img) {
                    const bikeName = $('#qr-bike-name').text();
                    const link = document.createElement('a');
                    link.download = `qr-${bikeName.replace(/\s+/g, '-')}.png`;
                    link.href = img.src;
                    link.click();
                }
            });
            
            // QR Code Scanning
            let stream = null;
            let scanning = false;
            
            // Quick scan button
            $('#quick-scan-btn').click(function() {
                $('#quickScanModal').modal('show');
            });
            
            // Modal camera scan
            $('#modal-camera-scan-btn').click(function() {
                startModalCameraScan();
            });
            
            // Modal upload scan
            $('#modal-upload-scan-btn').click(function() {
                $('#modal-file-input').click();
            });
            
            $('#modal-file-input').change(function(e) {
                const file = e.target.files[0];
                if (file) {
                    scanQRFromImage(file, 'modal');
                }
            });
            
            // Modal stop camera
            $('#modal-stop-camera-btn').click(function() {
                stopModalCamera();
            });
            
            // Regular camera scan
            $('#camera-scan-btn').click(function() {
                startCameraScan();
            });
            
            // Regular upload scan
            $('#upload-scan-btn').click(function() {
                $('#file-input').click();
            });
            
            $('#file-input').change(function(e) {
                const file = e.target.files[0];
                if (file) {
                    scanQRFromImage(file, 'regular');
                }
            });
            
            // Stop camera
            $('#stop-camera-btn').click(function() {
                stopCamera();
            });
            
            // Assembly form submission
            $('#assembly-form').submit(function(e) {
                e.preventDefault();
                
                const bikeIds = $('#assembly-form').data('bikeIds');
                const quantity = parseInt($('#assembly-quantity').val());
                const assemblyDate = $('#assembly-date').val();
                const assembler = $('#assembly-assembler').val();
                
                // Mark bikes as assembled
                let assembledCount = 0;
                bikeIds.forEach(bikeId => {
                    const bikeIndex = bikes.findIndex(bike => bike.id === bikeId && bike.status === 'unassembled');
                    if (bikeIndex !== -1 && assembledCount < quantity) {
                        bikes[bikeIndex].status = 'assembled';
                        bikes[bikeIndex].assemblyDate = assemblyDate;
                        bikes[bikeIndex].assembler = assembler;
                        assembledCount++;
                    }
                });
                
                localStorage.setItem('bikes', JSON.stringify(bikes));
                $('#assemblyModal').modal('hide');
                loadBikeList();
                updateDashboardCounts();
                
                alert(`Berhasil menandai ${assembledCount} unit sebagai sudah dirakit!`);
            });
            
            // Sale form submission
            $('#sale-form').submit(function(e) {
                e.preventDefault();
                
                const bikeIds = $('#sale-form').data('bikeIds');
                const quantity = parseInt($('#sale-quantity').val());
                const saleDate = $('#sale-date').val();
                
                // Mark bikes as sold
                let soldCount = 0;
                bikeIds.forEach(bikeId => {
                    const bikeIndex = bikes.findIndex(bike => bike.id === bikeId && bike.status === 'assembled');
                    if (bikeIndex !== -1 && soldCount < quantity) {
                        bikes[bikeIndex].status = 'sold';
                        bikes[bikeIndex].soldDate = saleDate;
                        soldCount++;
                    }
                });
                
                localStorage.setItem('bikes', JSON.stringify(bikes));
                $('#saleModal').modal('hide');
                loadBikeList();
                updateDashboardCounts();
                
                alert(`Berhasil menandai ${soldCount} unit sebagai terjual!`);
            });
            
            // Edit bike form submission
            $('#edit-bike-form').submit(function(e) {
                e.preventDefault();
                
                const bikeId = $('#edit-bike-id').val();
                const bikeIndex = bikes.findIndex(bike => bike.id === bikeId);
                
                if (bikeIndex !== -1) {
                    // Update bike data
                    bikes[bikeIndex].name = $('#edit-bike-name').val().toUpperCase();
                    bikes[bikeIndex].type = $('#edit-bike-type').val();
                    bikes[bikeIndex].size = $('#edit-bike-size').val();
                    bikes[bikeIndex].supplier = $('#edit-bike-supplier').val();
                    bikes[bikeIndex].package = $('#edit-bike-package').val();
                    
                    // Update photo if provided
                    const photoFile = $('#edit-bike-photo')[0].files[0];
                    if (photoFile) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            bikes[bikeIndex].photo = e.target.result;
                            localStorage.setItem('bikes', JSON.stringify(bikes));
                            $('#editBikeModal').modal('hide');
                            loadBikeList();
                            loadBikeSelect();
                            alert('Data sepeda berhasil diperbarui!');
                        };
                        reader.readAsDataURL(photoFile);
                    } else {
                        localStorage.setItem('bikes', JSON.stringify(bikes));
                        $('#editBikeModal').modal('hide');
                        loadBikeList();
                        loadBikeSelect();
                        alert('Data sepeda berhasil diperbarui!');
                    }
                }
            });
            
            // Export data
            $('#export-btn').click(function() {
                exportData();
            });
            
            // Initialize master data lists
            loadTypeList();
            loadSizeList();
            loadSupplierList();
            loadPackageList();
            loadAssemblerList();
        });
        
        // Function to initialize QR tabs
        function initializeQRTabs() {
            // Ensure tab content is properly shown
            $('#qrTabs .nav-link').on('shown.bs.tab', function(e) {
                const target = $(e.target).data('bs-target');
                $(target).addClass('show active');
            });
        }
        
        // Function to initialize master tabs
        function initializeMasterTabs() {
            // Ensure tab content is properly shown
            $('#masterTabs .nav-link').on('shown.bs.tab', function(e) {
                const target = $(e.target).data('bs-target');
                $(target).addClass('show active');
            });
        }
        
        // Function to load master data to forms
        function loadMasterDataToForms() {
            // Load types
            $('#bike-type, #edit-bike-type').html('<option value="">Pilih Tipe</option>');
            masterData.types.forEach(type => {
                $('#bike-type, #edit-bike-type').append(`<option value="${type}">${type}</option>`);
            });
            
            // Load sizes
            $('#bike-size, #edit-bike-size').html('<option value="">Pilih Ukuran</option>');
            masterData.sizes.forEach(size => {
                $('#bike-size, #edit-bike-size').append(`<option value="${size}">${size}</option>`);
            });
            
            // Load suppliers
            $('#bike-supplier, #edit-bike-supplier').html('<option value="">Pilih Supplier</option>');
            masterData.suppliers.forEach(supplier => {
                $('#bike-supplier, #edit-bike-supplier').append(`<option value="${supplier}">${supplier}</option>`);
            });
            
            // Load packages
            $('#bike-package, #edit-bike-package').html('<option value="">Pilih Kemasan</option>');
            masterData.packages.forEach(pkg => {
                $('#bike-package, #edit-bike-package').append(`<option value="${pkg}">${pkg}</option>`);
            });
        }
        
        // Function to load assemblers to form
        function loadAssemblersToForm() {
            $('#assembly-assembler').html('<option value="">Pilih Perakit</option>');
            masterData.assemblers.forEach(assembler => {
                $('#assembly-assembler').append(`<option value="${assembler}">${assembler}</option>`);
            });
        }
        
        // Function to load bike list
        function loadBikeList(status = 'all') {
            $('#bike-list').empty();
            
            let filteredBikes = bikes;
            const searchTerm = $('#search-input').val().toLowerCase();
            
            // Filter by status
            if (status !== 'all') {
                filteredBikes = filteredBikes.filter(bike => bike.status === status);
            }
            
            // Filter by search term
            if (searchTerm) {
                filteredBikes = filteredBikes.filter(bike => 
                    bike.name.toLowerCase().includes(searchTerm) ||
                    bike.type.toLowerCase().includes(searchTerm) ||
                    bike.size.toLowerCase().includes(searchTerm) ||
                    bike.supplier.toLowerCase().includes(searchTerm)
                );
            }
            
            // Group bikes by model (name + type + size + supplier + package + status)
            const bikeGroups = {};
            filteredBikes.forEach(bike => {
                const key = `${bike.name}-${bike.type}-${bike.size}-${bike.supplier}-${bike.package}-${bike.status}-${bike.arrivalDate}`;
                if (!bikeGroups[key]) {
                    bikeGroups[key] = {
                        name: bike.name,
                        type: bike.type,
                        size: bike.size,
                        supplier: bike.supplier,
                        package: bike.package,
                        status: bike.status,
                        arrivalDate: bike.arrivalDate,
                        unitsPerPackage: bike.unitsPerPackage,
                        packageQuantity: bike.packageQuantity,
                        totalUnits: bike.totalUnits,
                        count: 0,
                        bikeIds: [],
                        photo: bike.photo
                    };
                }
                bikeGroups[key].count++;
                bikeGroups[key].bikeIds.push(bike.id);
            });
            
            if (Object.keys(bikeGroups).length === 0) {
                $('#bike-list').html('<div class="text-center text-muted py-4">Tidak ada sepeda</div>');
                return;
            }
            
            Object.values(bikeGroups).forEach(group => {
                let statusBadge = '';
                let actions = '';
                
                if (group.status === 'unassembled') {
                    statusBadge = '<span class="status-badge status-unassembled">Belum Rakit</span>';
                    actions = `
                        <button class="btn btn-sm btn-success assemble-btn" data-ids='${JSON.stringify(group.bikeIds)}'>
                            <i class="fas fa-tools me-1"></i> Tandai Rakit
                        </button>
                    `;
                } else if (group.status === 'assembled') {
                    statusBadge = '<span class="status-badge status-assembled">Sudah Rakit</span>';
                    actions = `
                        <button class="btn btn-sm btn-danger sell-btn" data-ids='${JSON.stringify(group.bikeIds)}'>
                            <i class="fas fa-shopping-cart me-1"></i> Tandai Terjual
                        </button>
                    `;
                } else if (group.status === 'sold') {
                    statusBadge = '<span class="status-badge status-sold">Terjual</span>';
                }
                
                const assemblyInfo = group.status === 'assembled' || group.status === 'sold' ? 
                    `<br>Rakit: ${formatDate(group.assemblyDate)} oleh ${group.assembler}` : '';
                    
                const saleInfo = group.status === 'sold' ? 
                    `<br>Terjual: ${formatDate(group.soldDate)}` : '';
                
                $('#bike-list').append(`
                    <div class="card bike-item">
                        <div class="card-body bike-card-content">
                            ${group.count > 1 ? `<div class="unit-count-badge">${group.count}</div>` : ''}
                            ${group.photo ? 
                                `<img src="${group.photo}" class="bike-image" alt="${group.name}">` : 
                                `<div class="image-placeholder">
                                    <i class="fas fa-bicycle fa-2x"></i>
                                </div>`
                            }
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h5 class="card-title">${group.name}</h5>
                                    <p class="card-text mb-1">
                                        <small class="text-muted">
                                            ${group.type} - ${group.size}<br>
                                            Supplier: ${group.supplier} | Kemasan: ${group.package}
                                            ${group.totalUnits > 1 ? `<br>${group.packageQuantity} kemasan  ${group.unitsPerPackage} unit` : ''}
                                        </small>
                                    </p>
                                    <p class="card-text mb-0">
                                        <small>
                                            Kedatangan: ${formatDate(group.arrivalDate)}
                                            ${assemblyInfo}
                                            ${saleInfo}
                                            <br>Total Unit: ${group.count}
                                        </small>
                                    </p>
                                </div>
                                ${statusBadge}
                            </div>
                            <div class="mt-3 action-buttons">
                                ${actions}
                                <button class="btn btn-sm btn-outline-secondary view-qr-btn" data-id="${group.bikeIds[0]}">
                                    <i class="fas fa-qrcode me-1"></i> QR Code
                                </button>
                                <button class="btn btn-sm btn-outline-primary edit-btn" data-id="${group.bikeIds[0]}">
                                    <i class="fas fa-edit me-1"></i> Edit
                                </button>
                            </div>
                        </div>
                    </div>
                `);
            });
            
            // Add event listeners for action buttons
            $('.assemble-btn').click(function() {
                const bikeIds = JSON.parse($(this).data('ids'));
                $('#assembly-form').data('bikeIds', bikeIds);
                $('#assembly-quantity').val(1);
                $('#assembly-quantity').attr('max', bikeIds.length);
                $('#assemblyModal').modal('show');
            });
            
            $('.sell-btn').click(function() {
                const bikeIds = JSON.parse($(this).data('ids'));
                $('#sale-form').data('bikeIds', bikeIds);
                $('#sale-quantity').val(1);
                $('#sale-quantity').attr('max', bikeIds.length);
                $('#saleModal').modal('show');
            });
            
            $('.view-qr-btn').click(function() {
                const bikeId = $(this).data('id');
                
                // Navigate to QR page
                $('.nav-item').removeClass('active');
                $('.nav-item[data-page="qr-page"]').addClass('active');
                $('.page').removeClass('active');
                $('#qr-page').addClass('active');
                
                // Select the bike in dropdown
                $('#bike-select').val(bikeId).trigger('change');
                
                // Switch to generate tab
                $('#qrTabs .nav-link').removeClass('active');
                $('#generate-tab').addClass('active');
                $('#qrTabsContent .tab-pane').removeClass('show active');
                $('#generate').addClass('show active');
            });
            
            $('.edit-btn').click(function() {
                const bikeId = $(this).data('id');
                const bike = bikes.find(b => b.id === bikeId);
                
                if (bike) {
                    $('#edit-bike-id').val(bike.id);
                    $('#edit-bike-name').val(bike.name);
                    $('#edit-bike-type').val(bike.type);
                    $('#edit-bike-size').val(bike.size);
                    $('#edit-bike-supplier').val(bike.supplier);
                    $('#edit-bike-package').val(bike.package);
                    
                    // Show photo if exists
                    if (bike.photo) {
                        $('#edit-photo-preview-container').html(`<img src="${bike.photo}" class="photo-preview" alt="Preview">`);
                    } else {
                        $('#edit-photo-preview-container').empty();
                    }
                    
                    $('#editBikeModal').modal('show');
                }
            });
        }
        
        // Function to update dashboard counts
        function updateDashboardCounts() {
            const unassembledCount = bikes.filter(bike => bike.status === 'unassembled').length;
            const assembledCount = bikes.filter(bike => bike.status === 'assembled').length;
            const lowStockCount = bikes.filter(bike => {
                // Count bikes that have 2 or less units of the same model
                const sameModelBikes = bikes.filter(b => 
                    b.name === bike.name && 
                    b.type === bike.type && 
                    b.size === bike.size && 
                    b.supplier === bike.supplier
                );
                return sameModelBikes.length <= 2;
            }).length;
            
            $('#unassembled-count').text(unassembledCount);
            $('#assembled-count').text(assembledCount);
            $('#low-stock-count').text(lowStockCount);
        }
        
        // Function to load bike select for QR generation
        function loadBikeSelect() {
            $('#bike-select').html('<option value="">Pilih sepeda untuk generate QR</option>');
            bikes.forEach(bike => {
                const unitInfo = bike.totalUnits > 1 ? 
                    ` (Unit ${bike.unitNumber}/${bike.totalUnits})` : '';
                $('#bike-select').append(`<option value="${bike.id}">${bike.name}${unitInfo}</option>`);
            });
        }
        
        // Function to start modal camera scan
        function startModalCameraScan() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                $('#modal-camera-container').show();
                $('#modal-camera-scan-btn').prop('disabled', true);
                scanning = true;
                
                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                    .then(function(mediaStream) {
                        stream = mediaStream;
                        const video = document.getElementById('modal-camera-feed');
                        video.srcObject = stream;
                        
                        // Start scanning for QR codes
                        scanFromCamera(video, 'modal');
                    })
                    .catch(function(err) {
                        console.error('Error accessing camera:', err);
                        $('#modal-scan-result').html('<div class="alert alert-danger">Tidak dapat mengakses kamera. Pastikan Anda memberikan izin akses kamera.</div>');
                        $('#modal-camera-container').hide();
                        $('#modal-camera-scan-btn').prop('disabled', false);
                        scanning = false;
                    });
            } else {
                $('#modal-scan-result').html('<div class="alert alert-warning">Browser tidak mendukung akses kamera.</div>');
            }
        }
        
        // Function to start regular camera scan
        function startCameraScan() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                $('#camera-container').show();
                $('#camera-scan-btn').prop('disabled', true);
                scanning = true;
                
                navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                    .then(function(mediaStream) {
                        stream = mediaStream;
                        const video = document.getElementById('camera-feed');
                        video.srcObject = stream;
                        
                        // Start scanning for QR codes
                        scanFromCamera(video, 'regular');
                    })
                    .catch(function(err) {
                        console.error('Error accessing camera:', err);
                        $('#scan-result').html('<div class="alert alert-danger">Tidak dapat mengakses kamera. Pastikan Anda memberikan izin akses kamera.</div>');
                        $('#camera-container').hide();
                        $('#camera-scan-btn').prop('disabled', false);
                        scanning = false;
                    });
            } else {
                $('#scan-result').html('<div class="alert alert-warning">Browser tidak mendukung akses kamera.</div>');
            }
        }
        
        // Function to scan QR from camera
        function scanFromCamera(video, type) {
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            function scan() {
                if (video.readyState === video.HAVE_ENOUGH_DATA && scanning) {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                    
                    // Use jsQR library for QR code detection
                    const code = jsQR(imageData.data, imageData.width, imageData.height);
                    
                    if (code) {
                        const bikeId = code.data;
                        const bike = bikes.find(b => b.id === bikeId);
                        
                        if (bike) {
                            const unitInfo = bike.totalUnits > 1 ? 
                                ` (Unit ${bike.unitNumber}/${bike.totalUnits})` : '';
                                
                            const resultHtml = `
                                <div class="alert alert-success">
                                    <h5>${bike.name}${unitInfo}</h5>
                                    <p class="mb-1">${bike.type} - ${bike.size}</p>
                                    <p class="mb-1">Status: ${getStatusText(bike.status)}</p>
                                    <p class="mb-1">Supplier: ${bike.supplier}</p>
                                    <p class="mb-0">Kedatangan: ${formatDate(bike.arrivalDate)}</p>
                                </div>
                            `;
                            
                            if (type === 'modal') {
                                $('#modal-scan-result').html(resultHtml);
                                stopModalCamera();
                                $('#quickScanModal').modal('hide');
                            } else {
                                $('#scan-result').html(resultHtml);
                                stopCamera();
                            }
                        } else {
                            const errorHtml = '<div class="alert alert-warning">Sepeda tidak ditemukan dalam database</div>';
                            if (type === 'modal') {
                                $('#modal-scan-result').html(errorHtml);
                            } else {
                                $('#scan-result').html(errorHtml);
                            }
                        }
                    }
                }
                
                if (scanning) {
                    requestAnimationFrame(scan);
                }
            }
            
            scan();
        }
        
        // Function to scan QR from image file
        function scanQRFromImage(file, type) {
            const img = new Image();
            const url = URL.createObjectURL(file);
            
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.width = img.width;
                canvas.height = img.height;
                context.drawImage(img, 0, 0);
                
                const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                
                // Use jsQR library for QR code detection
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                
                if (code) {
                    const bikeId = code.data;
                    const bike = bikes.find(b => b.id === bikeId);
                    
                    if (bike) {
                        const unitInfo = bike.totalUnits > 1 ? 
                            ` (Unit ${bike.unitNumber}/${bike.totalUnits})` : '';
                            
                        const resultHtml = `
                            <div class="alert alert-success">
                                <h5>${bike.name}${unitInfo}</h5>
                                <p class="mb-1">${bike.type} - ${bike.size}</p>
                                <p class="mb-1">Status: ${getStatusText(bike.status)}</p>
                                <p class="mb-1">Supplier: ${bike.supplier}</p>
                                <p class="mb-0">Kedatangan: ${formatDate(bike.arrivalDate)}</p>
                            </div>
                        `;
                        
                        if (type === 'modal') {
                            $('#modal-scan-result').html(resultHtml);
                            $('#quickScanModal').modal('hide');
                        } else {
                            $('#scan-result').html(resultHtml);
                        }
                    } else {
                        const errorHtml = '<div class="alert alert-warning">Sepeda tidak ditemukan dalam database</div>';
                        if (type === 'modal') {
                            $('#modal-scan-result').html(errorHtml);
                        } else {
                            $('#scan-result').html(errorHtml);
                        }
                    }
                } else {
                    const errorHtml = '<div class="alert alert-danger">Tidak dapat membaca QR code dari gambar.</div>';
                    if (type === 'modal') {
                        $('#modal-scan-result').html(errorHtml);
                    } else {
                        $('#scan-result').html(errorHtml);
                    }
                }
                
                URL.revokeObjectURL(url);
            };
            
            img.src = url;
        }
        
        // Function to stop modal camera
        function stopModalCamera() {
            scanning = false;
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            $('#modal-camera-container').hide();
            $('#modal-camera-scan-btn').prop('disabled', false);
        }
        
        // Function to stop camera
        function stopCamera() {
            scanning = false;
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            $('#camera-container').hide();
            $('#camera-scan-btn').prop('disabled', false);
        }
        
        // Function to export data
        function exportData() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify({
                bikes: bikes,
                masterData: masterData
            }, null, 2));
            
            const downloadAnchor = document.createElement('a');
            downloadAnchor.setAttribute("href", dataStr);
            downloadAnchor.setAttribute("download", "inventaris-sepeda-backup.json");
            document.body.appendChild(downloadAnchor);
            downloadAnchor.click();
            downloadAnchor.remove();
        }
        
        // Function to load type list
        function loadTypeList() {
            $('#type-list').empty();
            masterData.types.forEach(type => {
                $('#type-list').append(`
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        ${type}
                        <button class="btn btn-sm btn-outline-danger delete-type" data-item="${type}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </li>
                `);
            });
            
            $('.delete-type').click(function() {
                const item = $(this).data('item');
                if (confirm(`Hapus tipe "${item}"?`)) {
                    masterData.types = masterData.types.filter(t => t !== item);
                    localStorage.setItem('masterData', JSON.stringify(masterData));
                    loadMasterDataToForms();
                    loadTypeList();
                }
            });
        }
        
        // Function to load size list
        function loadSizeList() {
            $('#size-list').empty();
            masterData.sizes.forEach(size => {
                $('#size-list').append(`
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        ${size}
                        <button class="btn btn-sm btn-outline-danger delete-size" data-item="${size}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </li>
                `);
            });
            
            $('.delete-size').click(function() {
                const item = $(this).data('item');
                if (confirm(`Hapus ukuran "${item}"?`)) {
                    masterData.sizes = masterData.sizes.filter(s => s !== item);
                    localStorage.setItem('masterData', JSON.stringify(masterData));
                    loadMasterDataToForms();
                    loadSizeList();
                }
            });
        }
        
        // Function to load supplier list
        function loadSupplierList() {
            $('#supplier-list').empty();
            masterData.suppliers.forEach(supplier => {
                $('#supplier-list').append(`
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        ${supplier}
                        <button class="btn btn-sm btn-outline-danger delete-supplier" data-item="${supplier}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </li>
                `);
            });
            
            $('.delete-supplier').click(function() {
                const item = $(this).data('item');
                if (confirm(`Hapus supplier "${item}"?`)) {
                    masterData.suppliers = masterData.suppliers.filter(s => s !== item);
                    localStorage.setItem('masterData', JSON.stringify(masterData));
                    loadMasterDataToForms();
                    loadSupplierList();
                }
            });
        }
        
        // Function to load package list
        function loadPackageList() {
            $('#package-list').empty();
            masterData.packages.forEach(pkg => {
                $('#package-list').append(`
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        ${pkg}
                        <button class="btn btn-sm btn-outline-danger delete-package" data-item="${pkg}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </li>
                `);
            });
            
            $('.delete-package').click(function() {
                const item = $(this).data('item');
                if (confirm(`Hapus kemasan "${item}"?`)) {
                    masterData.packages = masterData.packages.filter(p => p !== item);
                    localStorage.setItem('masterData', JSON.stringify(masterData));
                    loadMasterDataToForms();
                    loadPackageList();
                }
            });
        }
        
        // Function to load assembler list
        function loadAssemblerList() {
            $('#assembler-list').empty();
            masterData.assemblers.forEach(assembler => {
                $('#assembler-list').append(`
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        ${assembler}
                        <button class="btn btn-sm btn-outline-danger delete-assembler" data-item="${assembler}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </li>
                `);
            });
            
            $('.delete-assembler').click(function() {
                const item = $(this).data('item');
                if (confirm(`Hapus perakit "${item}"?`)) {
                    masterData.assemblers = masterData.assemblers.filter(a => a !== item);
                    localStorage.setItem('masterData', JSON.stringify(masterData));
                    loadAssemblersToForm();
                    loadAssemblerList();
                }
            });
        }
        
        // Helper function to format date
        function formatDate(dateString) {
            if (!dateString) return '-';
            const options = { day: '2-digit', month: '2-digit', year: 'numeric' };
            return new Date(dateString).toLocaleDateString('id-ID', options);
        }
        
        // Helper function to get status text
        function getStatusText(status) {
            switch(status) {
                case 'unassembled': return 'Belum Rakit';
                case 'assembled': return 'Sudah Rakit';
                case 'sold': return 'Terjual';
                default: return status;
            }
        }
    </script>
</body>
</html>
